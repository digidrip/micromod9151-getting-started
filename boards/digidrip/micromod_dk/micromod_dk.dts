/*
 * Copyright (c) 2025 Christian Hirsch
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;

#include <st/f1/stm32f103Xb.dtsi>
#include <st/f1/stm32f103t(8-b)ux-pinctrl.dtsi>

/ {
        model = "digidrip MicroMod DK board";
        compatible = "st,stm32f103";

        chosen {
                zephyr,console = &usart2;
                zephyr,shell-uart = &usart2;
                zephyr,sram = &sram0;
                zephyr,flash = &flash0;
        };

        leds {
                compatible = "gpio-leds";
                led_ind: led_ind {
                        gpios = <&gpioa 5 GPIO_ACTIVE_LOW>;
                        label = "Indication LED";
                };
                led_ind_rx: led_ind_rx {
                        gpios = <&gpioa 6 GPIO_ACTIVE_LOW>;
                        label = "RX indication LED";
                };
                led_ind_tx: led_ind_tx {
                        gpios = <&gpioa 7 GPIO_ACTIVE_LOW>;
                        label = "TX indication LED";
                };
                usb_dp: usb_dp {
                        gpios = <&gpioa 12 GPIO_ACTIVE_HIGH>;
                        label = "USB D+ pin";
                };
        };

        aliases {
                led0 = &led_ind;
                watchdog0 = &iwdg;
                die-temp0 = &die_temp;
        };

		//dp0 {
		//	compatible = "zephyr,swdp-gpio";
		//	status = "okay";
		//	clk-gpios = <&gpioa 8 GPIO_ACTIVE_HIGH>;	/* D4 */
		//	dio-gpios = <&gpioa 9 GPIO_PULL_UP>;		/* D2 */
		//	reset-gpios = <&gpioa 10 GPIO_ACTIVE_HIGH>;	/* D7 */
		//	port-write-cycles = <2>;
		//};
};

&clk_lsi {
        status = "okay";
};

&clk_hse {
    status = "okay";
    clock-frequency = <DT_FREQ_M(12)>; // External 12MHz clock
};

&pll {
    status = "okay";
    mul = <6>;
    clocks = <&clk_hse>;
};

&rcc {
    clocks = <&pll>;
    clock-frequency = <DT_FREQ_M(72)>;
    ahb-prescaler = <1>;
    apb1-prescaler = <2>;
	apb2-prescaler = <1>;
    // usbpre not set: USB clock = 72 / 1.5: 48MHz
};

arduino_serial: &usart2 {
        pinctrl-0 = <&usart2_tx_pa2 &usart2_rx_pa3>;
        pinctrl-names = "default";
        current-speed = <115200>;
        status = "okay";
};

&iwdg {
        status = "okay";
};

zephyr_udc0: &usb {
        pinctrl-0 = <&usb_dm_pa11 &usb_dp_pa12>;
        pinctrl-names = "default";
        status = "okay";
		/* maximum-speed = "full-speed"; */
};

&rtc {
        clocks = <&rcc STM32_CLOCK_BUS_APB1 0x10000000>,
                 <&rcc STM32_SRC_LSI RTC_SEL(2)>;
        status = "okay";
};

&die_temp {
        status = "okay";
};
